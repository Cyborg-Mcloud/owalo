<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://maps.googleapis.com https://fonts.googleapis.com">
	
  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Owalo</title>

	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFY47FE__z9AvRLBoYG0T2XeOTiHdwzOQ&libraries=places"></script>
  </head>
  <style>
	body {color:black; margin:0px; padding:0px; border:0px;}
	a {text-decoration:none; color:white;}
  </style>
  <body>
  
<canvas width=350px height=350px id='myCanvas' style='width:350px; border:1px solid red; height:350px;'></canvas>


  <div id='heading_div'></div>
<div id='map'>asdasdas </div>
<div id='text'></div>
  <div id='geopos' style='border:1px solid black; width:200px; height:200px;'></div>
  
<script>


var canvas = document.getElementById("myCanvas");
var canvasWidth = canvas.width;
var canvasHeight = canvas.height;
var ctx = canvas.getContext("2d");

var cmx=0;
var cmy=0;

var objs=new Array();



function draw()
	{

	ctx.clearRect(0, 0, canvasWidth, canvasHeight);

	ctx.fillStyle="#00FF00";	
	
	ctx.beginPath();
	ctx.moveTo(175,175);

	cmx=Math.sin(comp*6.28/360)*50;
	cmy=-Math.cos(comp*6.28/360)*50;

	ctx.lineTo(175+cmx,175+cmy);
	ctx.stroke();

	for (i=0;i<objs.length ;i++ )
		{
		a=objs[i][0]-MyLat;
		b=objs[i][1]-MyLong;
		a=111*a;
		b=111*b;
		a=parseInt(a*1000);
		b=parseInt(b*1000);

		ctx.fillRect(175+a,175-b,2,2);
		ctx.font = "14px Arial";
		ctx.fillText(objs[i][3],175+a,175-b); 

		}
	

	setTimeout("draw();",500);
	}

   var watchID = null;
   var watchID2 = null;

var MyLat;
var MyLong;
var MyAlt;
var MyHead;
var MySpeed;
var MyAcc;

var comp=0;

function onDeviceReady() 
	{
    document.removeEventListener('deviceready', onDeviceReady, false);

	console.log("device ready, getting position");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
	var opts = { timeout: 5000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onSuccess, onError, opts);
	console.log("compass init");
	//navigator.Compass.getCurrentHeading(onCompassSuccess, onError);

	 var moptions = { frequency: 100 };

	watchID2 = navigator.compass.watchHeading(onCompassSuccess, onError, moptions);


	//setTimeout("StartWebView();",200); 
    }


function onSuccess(position) 
	{
	console.log("on GPS success");
		
	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy;

	console.log(MyLat+ " - "+MyLong);
	document.getElementById("text").innerHTML="";
	initialize();

	document.getElementById('geopos').innerHTML = 'Latitude: '           + MyLat             + '<br />' +
								'Longitude: '          + MyLong            + '<br />'+
								'Accuracy: '          + MyAcc            + '<br />';

    }

document.addEventListener("deviceready", onDeviceReady, false);

function onCompassSuccess(heading) {
       // alert('Heading: ' + heading.magneticHeading);
	  // console.log("heading: "+heading.magneticHeading);
	  comp=parseInt(heading.magneticHeading);
document.getElementById("heading_div").innerHTML=parseInt(heading.magneticHeading);
    }


function onError()
	{
	alert("error");
	}



var map;
var service;
var infowindow;

function initialize() {
 // var pyrmont = new google.maps.LatLng(41.707265,44.769453622);

var pyrmont = new google.maps.LatLng(MyLat,MyLong);
console.log("initializing");


  map = new google.maps.Map(document.getElementById('map'), {
      center: pyrmont,
      zoom: 15
    });

  var request = {
    location: pyrmont,
    radius: '500'
  };

  service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, callback);
}

function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      var place = results[i];
    //  createMarker(results[i]);
	objs[i]=new Array();
	objs[i][0]=results[i].geometry.viewport.f.b;
	objs[i][1]=results[i].geometry.viewport.b.b;
	objs[i][2]=results[i].icon;
	objs[i][3]=results[i].name;

	document.getElementById("text").innerHTML+="<img width=20px src='"+results[i].icon+"'> "+results[i].name+" | "+results[i].geometry.viewport.f.b+ " / "+results[i].geometry.viewport.b.b+"<BR>";

	//alert(results[i].name);
	//console.log(results[i].geometry.viewport.b);
	// console.log(results[i]);
    }
  }
}

	setTimeout("draw();",500);

</script>

</body>



</html>
